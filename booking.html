<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking Calendar | Sampark Lodge</title>

<style>
:root{
  --gold:#f6e58d;
  --gold-border:#b7950b;
  --text:#2c2c2c;
  --bg:#f4f4f4;
  --blue:#1976d2;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}

h1{
  text-align:center;
  margin-bottom:10px;
  font-size:1.6rem;
}

/* controls */
.controls{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  margin-bottom:10px;
}
.controls button{
  padding:6px 14px;
  cursor:pointer;
}
#year{
  font-size:1.4rem;
  font-weight:bold;
}

.admin-bar{
  text-align:center;
  margin-bottom:14px;
}
#adminBtn{
  padding:6px 14px;
  border:none;
  background:#333;
  color:#fff;
  cursor:pointer;
}
#adminBtn.active{
  background:#2e7d32;
}

/* calendar grid */
.calendar{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:16px;
}
@media(max-width:700px){
  .calendar{ grid-template-columns:1fr; }
}

/* month */
.month{
  background:#fff;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  overflow:hidden;
}
.month h2{
  background:#333;
  color:#fff;
  text-align:center;
  padding:6px;
  font-size:1rem;
}

/* weekdays & days */
.weekdays,.days{
  display:grid;
  grid-template-columns:repeat(7,1fr);
}
.weekdays div{
  text-align:center;
  font-size:.7rem;
  padding:4px;
  background:#eee;
}

/* day cell */
.day{
  min-height:64px;
  border:1px solid #eee;
  text-align:center;
  padding:4px;
  position:relative;
  cursor:default;
}
.day.admin{
  cursor:pointer;
}
.day.admin:hover{
  background:#e3f2fd;
}

.day.booked{
  background:var(--gold);
  box-shadow:inset 0 0 0 2px var(--gold-border);
}

.eng{
  font-weight:700;
  font-size:1rem;
}
.bn{
  font-size:.7rem;
  color:#555;
}

.today::after{
  content:'';
  position:absolute;
  inset:2px;
  border:2px solid var(--blue);
  pointer-events:none;
}

/* loader */
.loader{
  position:fixed;
  inset:0;
  background:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:999;
}
</style>
</head>

<body>

<div id="loader" class="loader">
  <div style="font-size:1.2rem;">Checking available dates…</div>
  <small>Syncing with Sampark Lodge</small>
</div>

<h1>Sampark Lodge – Booking Calendar</h1>

<div class="controls">
  <button onclick="changeYear(-1)">‹</button>
  <div id="year"></div>
  <button onclick="changeYear(1)">›</button>
</div>

<div class="admin-bar">
  <span id="status">Guest view</span><br>
  <button id="adminBtn" onclick="toggleAdmin()">Admin Access</button>
</div>

<div id="calendar" class="calendar"></div>

<script>
/* ================= CONFIG ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycbzts3-BHw_-Vhm0S5j3P5s6ZtioILUQxp0kN_AFqe7yiAyPWFN69KTgESIMfOJYzPtU6w/exec";

const MIN_YEAR = 2025;
const MAX_YEAR = 2040;

/* ================= STATE ================= */
let year = new Date().getFullYear();
if(year < MIN_YEAR) year = MIN_YEAR;
if(year > MAX_YEAR) year = MAX_YEAR;

let booked = new Set();
let admin = false;

/* ================= INIT ================= */
document.getElementById("year").textContent = year;
loadData();

/* ================= DATA ================= */
async function loadData(){
  document.getElementById("loader").style.display="flex";
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    booked.clear();
    data.forEach(d => booked.add(d.date));
    render();
  }catch(e){
    alert("Failed to load booking data");
  }
  document.getElementById("loader").style.display="none";
}

async function toggleDate(date){
  if(!admin) return;

  // optimistic UI
  if(booked.has(date)) booked.delete(date);
  else booked.add(date);

  render();

  // backend toggle
  await fetch(API_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ date })
  });
}

/* ================= ADMIN ================= */
function toggleAdmin(){
  if(admin){
    admin = false;
  }else{
    const p = prompt("Enter admin password");
    if(p !== "admin") return alert("Wrong password");
    admin = true;
  }
  document.getElementById("adminBtn").classList.toggle("active", admin);
  document.getElementById("status").textContent = admin ? "Admin mode" : "Guest view";
  render();
}

/* ================= YEAR ================= */
function changeYear(d){
  const y = year + d;
  if(y < MIN_YEAR || y > MAX_YEAR) return;
  year = y;
  document.getElementById("year").textContent = year;
  render();
}

/* ================= CALENDAR ================= */
const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const bnMonths = ["Boishakh","Joishtho","Asharh","Srabon","Bhadro","Ashwin","Kartik","Ograhayon","Poush","Magh","Falgun","Chaitra"];

function getBanglaDate(dateObj){
  const y = dateObj.getFullYear();
  const m = dateObj.getMonth();
  const d = dateObj.getDate();

  let by = y - 593;
  if(m < 3 || (m === 3 && d < 14)) by--;

  const starts = [
    [0,15,9],[1,14,10],[2,15,11],[3,14,0],[4,15,1],[5,15,2],
    [6,16,3],[7,16,4],[8,16,5],[9,16,6],[10,15,7],[11,16,8]
  ];

  let bm = 8, bd = d;
  for(let i = starts.length-1; i >= 0; i--){
    const s = starts[i];
    const sd = new Date(y, s[0], s[1]);
    if(dateObj >= sd){
      bm = s[2];
      bd = Math.floor((dateObj - sd)/86400000) + 1;
      break;
    }
  }
  return `${bd} ${bnMonths[bm]} ${by}`;
}

function render(){
  const root = document.getElementById("calendar");
  root.innerHTML = "";

  const today = new Date().toISOString().slice(0,10);

  for(let m=0; m<12; m++){
    const box = document.createElement("div");
    box.className = "month";
    box.innerHTML = `
      <h2>${months[m]}</h2>
      <div class="weekdays">${"SMTWTFS".split("").map(d=>`<div>${d}</div>`).join("")}</div>
    `;

    const days = document.createElement("div");
    days.className = "days";

    const first = new Date(year, m, 1).getDay();
    const total = new Date(year, m+1, 0).getDate();

    for(let i=0;i<first;i++) days.appendChild(document.createElement("div"));

    for(let d=1; d<=total; d++){
      const dateStr = `${year}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const cell = document.createElement("div");
      cell.className = "day";
      if(admin) cell.classList.add("admin");
      if(booked.has(dateStr)) cell.classList.add("booked");
      if(dateStr === today) cell.classList.add("today");

      cell.innerHTML = `
        <div class="eng">${d}</div>
        <div class="bn">${getBanglaDate(new Date(year,m,d))}</div>
      `;

      if(admin) cell.onclick = () => toggleDate(dateStr);

      days.appendChild(cell);
    }

    box.appendChild(days);
    root.appendChild(box);
  }
}
</script>
</body>
</html>
