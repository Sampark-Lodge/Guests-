<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sampark Lodge | Admin Calendar</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

<style>
:root{
  --gold:#D4AF37;
  --gold-dim:#C5A028;
  --bg:#f4f4f4;
  --white:rgba(255,255,255,.96);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Lato,sans-serif;
  background:var(--bg);
  min-height:100vh;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
header{
  background:var(--white);
  border-bottom:3px solid var(--gold);
  padding:20px;
  border-radius:8px;
  text-align:center;
  margin-bottom:25px;
}
h1{
  font-family:Cinzel,serif;
}
.year-nav{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-top:15px;
  font-family:Cinzel,serif;
  font-size:1.5rem;
}
button{
  cursor:pointer;
}
.nav-btn{
  border:2px solid var(--gold);
  background:none;
  padding:2px 12px;
  border-radius:4px;
}
.calendar-grid{
  display:grid;
  gap:20px;
}
@media(min-width:768px){
  .calendar-grid{grid-template-columns:1fr 1fr;}
}
.month-card{
  background:var(--white);
  border-radius:8px;
  padding:15px;
  border:1px solid rgba(212,175,55,.2);
}
.month-title{
  text-align:center;
  font-family:Cinzel,serif;
  color:var(--gold-dim);
  margin-bottom:10px;
}
.days-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
}
.weekday{
  text-align:center;
  font-size:.75rem;
  font-weight:bold;
  color:#777;
}
.day-cell{
  aspect-ratio:1;
  border:1px solid #eee;
  border-radius:4px;
  background:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  cursor:pointer;
}
.day-cell.booked{
  background:var(--gold);
  color:#fff;
}
.day-cell.today{
  border:2px solid var(--gold);
}
.day-cell.empty{
  border:none;
  background:transparent;
  cursor:default;
}
.date-eng{
  font-weight:700;
  font-size:1rem;
}
.date-ben{
  font-size:.65rem;
  margin-top:4px;
}
#modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
.modal{
  background:#fff;
  padding:20px;
  border-radius:8px;
  width:90%;
  max-width:400px;
  border-top:5px solid var(--gold);
}
.modal textarea{
  width:100%;
  min-height:80px;
  margin:10px 0;
}
.modal-actions{
  display:flex;
  gap:10px;
}
.btn-save{background:var(--gold);color:#fff;border:none;padding:10px}
.btn-delete{background:#c9302c;color:#fff;border:none;padding:10px}
.btn-cancel{background:#ccc;border:none;padding:10px}
</style>
</head>

<body>

<div class="container">
<header>
  <h1>Sampark Lodge</h1>
  <p>ADMIN BOOKING CALENDAR</p>
  <div class="year-nav">
    <button class="nav-btn" onclick="changeYear(-1)">‹</button>
    <span id="yearDisplay"></span>
    <button class="nav-btn" onclick="changeYear(1)">›</button>
  </div>
</header>

<div class="calendar-grid" id="calendarGrid"></div>
</div>

<div id="modal-overlay">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <textarea id="noteInput" placeholder="Admin note"></textarea>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button id="actionBtn" class="btn-save" onclick="saveBooking()">Save</button>
    </div>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzts3-BHw_-Vhm0S5j3P5s6ZtioILUQxp0kN_AFqe7yiAyPWFN69KTgESIMfOJYzPtU6w/exec";
let currentYear=new Date().getFullYear();
let bookings={};
let activeDate=null;

/* ========= PANJIKA FUNCTION (FINAL) ========= */
function getBengaliPanjika(d){
  const y=d.getFullYear(),m=d.getMonth(),day=d.getDate();
  const months=[
    {n:"পৌষ",s:new Date(y-1,11,16)},
    {n:"মাঘ",s:new Date(y,0,15)},
    {n:"ফাল্গুন",s:new Date(y,1,14)},
    {n:"চৈত্র",s:new Date(y,2,15)},
    {n:"বৈশাখ",s:new Date(y,3,14)},
    {n:"জ্যৈষ্ঠ",s:new Date(y,4,15)},
    {n:"আষাঢ়",s:new Date(y,5,15)},
    {n:"শ্রাবণ",s:new Date(y,6,16)},
    {n:"ভাদ্র",s:new Date(y,7,16)},
    {n:"আশ্বিন",s:new Date(y,8,16)},
    {n:"কার্তিক",s:new Date(y,9,16)},
    {n:"অগ্রহায়ণ",s:new Date(y,10,15)}
  ];
  let bnMonth="পৌষ",bnDay=day;
  for(let i=months.length-1;i>=0;i--){
    if(d>=months[i].s){
      bnDay=Math.floor((d-months[i].s)/86400000)+1;
      bnMonth=months[i].n;
      break;
    }
  }
  let bnYear=y-593;
  if(m<3||(m===3&&day<14)) bnYear=y-594;
  const suf=bnDay===1?"লা":bnDay===2||bnDay===3?"রা":"শে";
  return `${bnDay}${suf} ${bnMonth} ${bnYear}`;
}

/* ========= CALENDAR ========= */
async function fetchBookings(){
  const r=await fetch(API_URL);
  const d=await r.json();
  bookings={};
  d.forEach(x=>bookings[x.date]=x.note||"");
  render();
}

function render(){
  document.getElementById("yearDisplay").innerText=currentYear;
  const grid=document.getElementById("calendarGrid");
  grid.innerHTML="";
  const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
  for(let m=0;m<12;m++){
    const card=document.createElement("div");
    card.className="month-card";
    let h=`<div class="month-title">${months[m]}</div><div class="days-grid">`;
    ["S","M","T","W","T","F","S"].forEach(d=>h+=`<div class="weekday">${d}</div>`);
    const fd=new Date(currentYear,m,1).getDay();
    for(let i=0;i<fd;i++)h+=`<div class="day-cell empty"></div>`;
    const dim=new Date(currentYear,m+1,0).getDate();
    for(let d=1;d<=dim;d++){
      const iso=`${currentYear}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const dateObj=new Date(currentYear,m,d);
      const bn=getBengaliPanjika(dateObj);
      h+=`<div class="day-cell ${bookings[iso]?"booked":""}" onclick="openModal('${iso}')">
            <div class="date-eng">${d}</div>
            <div class="date-ben">${bn}</div>
          </div>`;
    }
    h+="</div>";
    card.innerHTML=h;
    grid.appendChild(card);
  }
}

function openModal(date){
  activeDate=date;
  document.getElementById("modalTitle").innerText=date;
  document.getElementById("noteInput").value=bookings[date]||"";
  document.getElementById("actionBtn").className=bookings[date]?"btn-delete":"btn-save";
  document.getElementById("actionBtn").innerText=bookings[date]?"Remove":"Save";
  document.getElementById("modal-overlay").style.display="flex";
}

function closeModal(){
  document.getElementById("modal-overlay").style.display="none";
}

async function saveBooking(){
  const note=document.getElementById("noteInput").value;
  const fd=new URLSearchParams({date:activeDate,note});
  await fetch(API_URL,{method:"POST",mode:"no-cors",body:fd});
  closeModal();
  fetchBookings();
}

function changeYear(n){
  currentYear+=n;
  render();
}

/* ========= INIT ========= */
if(prompt("Admin Password")==="admin"){
  fetchBookings();
}else{
  document.body.innerHTML="<h2 style='text-align:center;margin-top:50px'>Access Denied</h2>";
}
</script>
</body>
</html>