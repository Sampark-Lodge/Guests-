<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sampark Lodge – Booking Calendar</title>

<style>
:root{
    --gold-bg:#fff176;
    --gold-border:#b8860b;
    --text-dark:#2c3e50;
    --text-light:#7f8c8d;
    --highlight:#3498db;
    --font-main:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu;
}
*{margin:0;padding:0;box-sizing:border-box}

body{
    font-family:var(--font-main);
    background:#f8f9fa;
    color:var(--text-dark);
    padding:20px;
}

/* Loader */
.loading-overlay{
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.95);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:9999;
    gap:6px;
}
.loading-overlay .main{
    font-size:1.4rem;
    font-weight:600;
}
.loading-overlay .sub{
    font-size:.9rem;
    color:#666;
}

/* Header */
.header-controls{
    background:#fff;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,.05);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:15px;
    margin-bottom:30px;
}

.year-nav{
    display:flex;
    align-items:center;
    gap:20px;
}
.year-nav button{
    padding:8px 18px;
    border-radius:6px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    font-size:1.2rem;
}
.year-nav button:disabled{opacity:.3;cursor:not-allowed}
.year-display{
    font-size:2rem;
    font-weight:700;
}

.admin-panel{
    display:flex;
    gap:10px;
    align-items:center;
}
#admin-btn{
    padding:6px 14px;
    border-radius:4px;
    border:none;
    background:#333;
    color:#fff;
    cursor:pointer;
}
#admin-btn.active{background:#27ae60}
#admin-status{
    font-size:.85rem;
    color:var(--text-light);
}

/* Calendar */
.calendar-year{
    max-width:1400px;
    margin:auto;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
    gap:30px;
}

.month-card{
    background:#fff;
    border-radius:8px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
    overflow:hidden;
}

.month-name{
    background:#2c3e50;
    color:#fff;
    text-align:center;
    padding:10px;
    font-weight:600;
}

.weekdays{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    background:#ecf0f1;
    font-size:.75rem;
    text-align:center;
    padding:6px 0;
    color:#777;
    font-weight:600;
}

.days-grid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
}

/* Day Cell */
.day{
    min-height:70px;
    border:1px solid #f0f0f0;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    background:#fff;
    position:relative;
}
.day.admin-enabled{cursor:pointer}

.greg-date{
    font-size:1.05rem;
    font-weight:700;
}
.bangla-date{
    font-size:.7rem;
    color:#777;
    text-align:center;
}

/* Booked */
.day.booked{
    background:var(--gold-bg);
    box-shadow:inset 0 0 0 3px var(--gold-border);
}
.day.booked .greg-date{color:#5d4037}
.day.booked .bangla-date{color:#6d4c41;font-weight:600}

/* Today */
.day.today::after{
    content:"";
    position:absolute;
    inset:3px;
    border:2px solid var(--highlight);
    border-radius:4px;
}

/* Hover admin */
.day.admin-enabled:hover{background:#e8f5e9}
.day.booked.admin-enabled:hover{background:#fff59d}

/* Mobile */
@media(max-width:600px){
    .calendar-year{grid-template-columns:1fr}
    .day{min-height:60px}
}
</style>
</head>

<body>

<!-- Loader -->
<div id="loader" class="loading-overlay">
    <div class="main">Checking Available Dates…</div>
    <div class="sub">Please wait while we sync with Sampark Lodge</div>
</div>

<div class="header-controls">
    <div class="year-nav">
        <button id="prevBtn" onclick="changeYear(-1)">‹</button>
        <div id="currentYearDisplay" class="year-display"></div>
        <button id="nextBtn" onclick="changeYear(1)">›</button>
    </div>
    <div class="admin-panel">
        <span id="admin-status">Guest View</span>
        <button id="admin-btn" onclick="toggleAdmin()">Admin Access</button>
    </div>
</div>

<div id="calendar-root" class="calendar-year"></div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzts3-BHw_-Vhm0S5j3P5s6ZtioILUQxp0kN_AFqe7yiAyPWFN69KTgESIMfOJYzPtU6w/exec";
const MIN_YEAR=2025,MAX_YEAR=2040;
let currentYear=new Date().getFullYear();
currentYear=Math.min(Math.max(currentYear,MIN_YEAR),MAX_YEAR);

let bookedSet=new Set();
let isAdmin=false;

const BN_MONTHS=["Boishakh","Joishtho","Asharh","Srabon","Bhadro","Ashwin","Kartik","Ograhayon","Poush","Magh","Falgun","Chaitra"];

window.onload=()=>fetchBookings();

async function fetchBookings(){
    document.getElementById("loader").style.display="flex";
    try{
        const res=await fetch(API_URL);
        const data=await res.json();
        bookedSet.clear();
        data.forEach(d=>bookedSet.add(d.date.split("T")[0]));
        renderCalendar();
    }catch(e){alert("Unable to load calendar");}
    document.getElementById("loader").style.display="none";
}

function toggleAdmin(){
    if(isAdmin){
        isAdmin=false;
        document.getElementById("admin-status").textContent="Guest View";
        document.getElementById("admin-btn").classList.remove("active");
        renderCalendar();
        return;
    }
    const p=prompt("Enter Admin Password");
    if(p==="admin"){
        isAdmin=true;
        document.getElementById("admin-status").textContent="Admin Mode";
        document.getElementById("admin-btn").classList.add("active");
        renderCalendar();
    }
}

function changeYear(d){
    const ny=currentYear+d;
    if(ny<MIN_YEAR||ny>MAX_YEAR)return;
    currentYear=ny;
    renderCalendar();
}

function renderCalendar(){
    document.getElementById("currentYearDisplay").textContent=currentYear;
    document.getElementById("prevBtn").disabled=currentYear<=MIN_YEAR;
    document.getElementById("nextBtn").disabled=currentYear>=MAX_YEAR;

    const root=document.getElementById("calendar-root");
    root.innerHTML="";
    const todayStr=new Date().toISOString().split("T")[0];
    const months=["January","February","March","April","May","June","July","August","September","October","November","December"];

    for(let m=0;m<12;m++){
        const card=document.createElement("div");
        card.className="month-card";

        card.innerHTML=`<div class="month-name">${months[m]}</div>
        <div class="weekdays">${["S","M","T","W","T","F","S"].map(d=>`<span>${d}</span>`).join("")}</div>`;

        const grid=document.createElement("div");
        grid.className="days-grid";

        const first=new Date(currentYear,m,1).getDay();
        const days=new Date(currentYear,m+1,0).getDate();

        for(let i=0;i<first;i++)grid.appendChild(document.createElement("div"));

        for(let d=1;d<=days;d++){
            const date=new Date(currentYear,m,d);
            const iso=date.toISOString().split("T")[0];
            const bn=getBengaliDate(date);
            const cell=document.createElement("div");
            cell.className="day";
            if(bookedSet.has(iso))cell.classList.add("booked");
            if(iso===todayStr)cell.classList.add("today");
            if(isAdmin){
                cell.classList.add("admin-enabled");
                cell.onclick=()=>toggleBooking(iso,cell);
            }
            cell.innerHTML=`<div class="greg-date">${d}</div>
            <div class="bangla-date">${bn.day} ${bn.month}<br>${bn.year}</div>`;
            grid.appendChild(cell);
        }

        card.appendChild(grid);
        root.appendChild(card);
    }
}

async function toggleBooking(date,cell){
    const was=bookedSet.has(date);
    was?bookedSet.delete(date):bookedSet.add(date);
    cell.classList.toggle("booked");
    await fetch(API_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({date})});
}

/* Bengali Date (approx) */
function getBengaliDate(d){
    const y=d.getFullYear(),m=d.getMonth(),da=d.getDate();
    let by=y-(m<3||m===3&&da<14?594:593);
    const starts=[[3,14,0],[4,15,1],[5,15,2],[6,16,3],[7,16,4],[8,16,5],[9,16,6],[10,15,7],[11,16,8],[0,15,9],[1,14,10],[2,15,11]];
    let bm=8,bd=1;
    for(let i=starts.length-1;i>=0;i--){
        const s=new Date(y,starts[i][0],starts[i][1]);
        if(d>=s){
            bd=Math.floor((d-s)/86400000)+1;
            bm=starts[i][2];
            break;
        }
    }
    return{day:bd,month:BN_MONTHS[bm],year:by};
}
</script>
</body>
</html>
