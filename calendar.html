<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sampark Lodge | Admin Calendar</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

<style>
:root{
  --c-gold: #D4AF37;
  --c-gold-dim: #C5A028;
  --c-gold-light: #F3E5AB;
  --c-bg-dark: #1a1a1a;
  --c-text-dark: #2c2c2c;
  --c-text-light: #f5f5f5;
  --c-white-translucent: rgba(255, 255, 255, 0.96);
  --font-heading: 'Cinzel', serif;
  --font-body: 'Lato', sans-serif;
  --shadow-card: 0 4px 15px rgba(0, 0, 0, 0.1);
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family: var(--font-body);
  background-color: #f4f4f4;
  /* Use your background image here if available */
  background-image: url("./assets/bg.png"); 
  background-size: cover;
  background-attachment: fixed;
  background-position: center;
  color: var(--c-text-dark);
  min-height: 100vh;
}

.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}

header{
  background: var(--c-white-translucent);
  border-bottom: 3px solid var(--c-gold);
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  margin-bottom: 25px;
  box-shadow: var(--shadow-card);
  position: relative;
}

h1{
  font-family: var(--font-heading);
  color: var(--c-text-dark);
}

.year-nav{
  display:flex;
  justify-content:center;
  align-items: center;
  gap:20px;
  margin-top:15px;
  font-family: var(--font-heading);
  font-size:1.5rem;
  font-weight: bold;
}

button{
  cursor:pointer;
}

.nav-btn{
  border: 2px solid var(--c-gold);
  background: none;
  padding: 2px 12px;
  border-radius: 4px;
  font-size: 1.2rem;
  transition: all 0.3s ease;
}

.nav-btn:hover {
  background: var(--c-gold);
  color: #fff;
}

/* Sync Button */
.sync-btn {
    position: absolute;
    right: 20px;
    top: 20px;
    background: transparent;
    border: 1px solid #ccc;
    color: #666;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 0.8rem;
    border-radius: 4px;
    transition: color 0.2s;
}
.sync-btn:hover { border-color: var(--c-gold); color: var(--c-gold); }

.calendar-grid{
  display:grid;
  gap:20px;
}

@media(min-width:768px){
  .calendar-grid{grid-template-columns:1fr 1fr;}
}

.month-card{
  background: var(--c-white-translucent);
  border-radius: 8px;
  padding: 15px;
  border: 1px solid rgba(212, 175, 55, 0.2);
  box-shadow: var(--shadow-card);
}

.month-title{
  text-align: center;
  font-family: var(--font-heading);
  color: var(--c-gold-dim);
  margin-bottom: 10px;
  font-weight: 700;
  text-transform: uppercase;
}

.days-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
}

.weekday{
  text-align: center;
  font-size: .75rem;
  font-weight: bold;
  color: #666;
}

.day-cell{
  aspect-ratio:1;
  border:1px solid #eee;
  border-radius:4px;
  background:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  transition: transform 0.1s, border-color 0.2s;
}

.day-cell:hover {
    border-color: var(--c-gold);
    transform: translateY(-1px);
}

.day-cell.booked{
  background: var(--c-gold);
  color: #fff;
  border-color: var(--c-gold-dim);
}
.day-cell.booked .date-ben {
    color: rgba(255,255,255, 0.9);
}

.day-cell.today{
  border:2px solid var(--c-gold);
}

.day-cell.empty{
  border:none;
  background:transparent;
  cursor:default;
}

.date-eng{
  font-weight:700;
  font-size:1rem;
  line-height: 1;
}

.date-ben{
  font-size:.65rem;
  margin-top:4px;
  color: #888;
  line-height: 1;
}

#modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index: 1000;
  backdrop-filter: blur(2px);
}

.modal{
  background:#fff;
  padding:25px;
  border-radius:8px;
  width:90%;
  max-width:400px;
  border-top:5px solid var(--c-gold);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal h3{
    font-family: var(--font-heading);
    margin-bottom: 10px;
    color: var(--c-text-dark);
    text-align: center;
    line-height: 1.4;
}

.modal textarea{
  width:100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-family: var(--font-body);
  min-height:80px;
  margin:15px 0;
  resize: vertical;
}

.modal textarea:focus {
    outline: none;
    border-color: var(--c-gold);
}

.modal-actions{
  display:flex;
  gap:10px;
  justify-content: space-between;
}

button.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    flex: 1;
    transition: background 0.2s;
}

.btn-save{background:var(--c-gold);color:#fff;}
.btn-save:hover { background: var(--c-gold-dim); }

.btn-delete{background:#d9534f;color:#fff;}
.btn-delete:hover { background: #c9302c; }

.btn-cancel{background:#e0e0e0;color:#333;}
</style>
</head>

<body>

<div class="container" id="app-container" style="display:none">
<header>
  <button class="sync-btn" onclick="fetchBookings()">â†» Sync</button>
  <h1>Sampark Lodge</h1>
  <p style="color: #666; font-size: 0.9rem;">ADMIN BOOKING CALENDAR</p>
  <div class="year-nav">
    <button class="nav-btn" onclick="changeYear(-1)">&#8249;</button>
    <span id="yearDisplay"></span>
    <button class="nav-btn" onclick="changeYear(1)">&#8250;</button>
  </div>
</header>

<div class="calendar-grid" id="calendarGrid"></div>
</div>

<div id="modal-overlay">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <textarea id="noteInput" placeholder="Admin note (e.g. Wedding, Advance Paid)"></textarea>
    <div class="modal-actions">
      <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
      <button id="actionBtn" class="btn btn-save" onclick="saveBooking()">Save</button>
    </div>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzts3-BHw_-Vhm0S5j3P5s6ZtioILUQxp0kN_AFqe7yiAyPWFN69KTgESIMfOJYzPtU6w/exec";
let currentYear=new Date().getFullYear();
let bookings={};
let activeDate=null;

/* ========= PANJIKA FUNCTION (FINAL) ========= */
function getBengaliPanjika(d){
  const y=d.getFullYear(),m=d.getMonth(),day=d.getDate();
  const months=[
    {n:"à¦ªà§Œà¦·",s:new Date(y-1,11,16)},
    {n:"à¦®à¦¾à¦˜",s:new Date(y,0,15)},
    {n:"à¦«à¦¾à¦²à§à¦—à§à¦¨",s:new Date(y,1,14)},
    {n:"à¦šà§ˆà¦¤à§à¦°",s:new Date(y,2,15)},
    {n:"à¦¬à§ˆà¦¶à¦¾à¦–",s:new Date(y,3,14)},
    {n:"à¦œà§à¦¯à§ˆà¦·à§à¦ ",s:new Date(y,4,15)},
    {n:"à¦†à¦·à¦¾à¦¢à¦¼",s:new Date(y,5,15)},
    {n:"à¦¶à§à¦°à¦¾à¦¬à¦£",s:new Date(y,6,16)},
    {n:"à¦­à¦¾à¦¦à§à¦°",s:new Date(y,7,16)},
    {n:"à¦†à¦¶à§à¦¬à¦¿à¦¨",s:new Date(y,8,16)},
    {n:"à¦•à¦¾à¦°à§à¦¤à¦¿à¦•",s:new Date(y,9,16)},
    {n:"à¦…à¦—à§à¦°à¦¹à¦¾à¦¯à¦¼à¦£",s:new Date(y,10,15)}
  ];
  let bnMonth="à¦ªà§Œà¦·",bnDay=day;
  for(let i=months.length-1;i>=0;i--){
    if(d>=months[i].s){
      bnDay=Math.floor((d-months[i].s)/86400000)+1;
      bnMonth=months[i].n;
      break;
    }
  }
  let bnYear=y-593;
  if(m<3||(m===3&&day<14)) bnYear=y-594;
  
  // Convert digits to Bengali
  const bnDigits = ['à§¦','à§§','à§¨','à§©','à§ª','à§«','à§¬','à§­','à§®','à§¯'];
  const toBnNum = (n) => n.toString().split('').map(d => bnDigits[parseInt(d)] || d).join('');
  
  const suf=bnDay===1?"à¦²à¦¾":bnDay===2||bnDay===3?"à¦°à¦¾":"à¦¶à§‡";
  return `${toBnNum(bnDay)}${suf} ${bnMonth} ${toBnNum(bnYear)}`;
}

/* ========= CALENDAR ========= */
async function fetchBookings(){
  try {
      const r=await fetch(API_URL);
      const d=await r.json();
      bookings={};
      d.forEach(x=>bookings[x.date]=x.note||"");
      render();
  } catch(e) {
      console.error("Sync error", e);
  }
}

function render(){
  document.getElementById("yearDisplay").innerText=currentYear;
  const grid=document.getElementById("calendarGrid");
  grid.innerHTML="";
  const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
  for(let m=0;m<12;m++){
    const card=document.createElement("div");
    card.className="month-card";
    let h=`<div class="month-title">${months[m]}</div><div class="days-grid">`;
    ["S","M","T","W","T","F","S"].forEach(d=>h+=`<div class="weekday">${d}</div>`);
    const fd=new Date(currentYear,m,1).getDay();
    for(let i=0;i<fd;i++)h+=`<div class="day-cell empty"></div>`;
    const dim=new Date(currentYear,m+1,0).getDate();
    for(let d=1;d<=dim;d++){
      const iso=`${currentYear}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const dateObj=new Date(currentYear,m,d);
      
      // Use the Panjika function
      const bn=getBengaliPanjika(dateObj); 
      // Simplified display for the cell (just Day Month)
      const bnCell = bn.split(' ').slice(0, 2).join(' '); 

      h+=`<div class="day-cell ${bookings[iso]?"booked":""}" onclick="openModal('${iso}')">
            <div class="date-eng">${d}</div>
            <div class="date-ben">${bnCell}</div>
          </div>`;
    }
    h+="</div>";
    card.innerHTML=h;
    grid.appendChild(card);
  }
}

function openModal(date){
  activeDate=date;
  
  // Setup Title with full English + Bengali Date
  const [y, m, d] = date.split('-').map(Number);
  const dateObj = new Date(y, m - 1, d);
  const engDate = new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric', year: 'numeric' }).format(dateObj);
  const bnFull = getBengaliPanjika(dateObj);
  
  document.getElementById("modalTitle").innerHTML = `${engDate}<br><span style="font-size:0.8em; color:#d4af37">${bnFull}</span>`;

  document.getElementById("noteInput").value=bookings[date]||"";
  const btn = document.getElementById("actionBtn");
  
  if(bookings[date]) {
      btn.className = "btn btn-delete";
      btn.innerText = "Remove Booking";
  } else {
      btn.className = "btn btn-save";
      btn.innerText = "Mark as Booked";
  }
  
  document.getElementById("modal-overlay").style.display="flex";
}

function closeModal(){
  document.getElementById("modal-overlay").style.display="none";
}

// Close on outside click
document.getElementById('modal-overlay').addEventListener('click', (e) => {
    if (e.target.id === 'modal-overlay') closeModal();
});

async function saveBooking(){
  const note=document.getElementById("noteInput").value;
  const wasBooked = bookings.hasOwnProperty(activeDate);
  
  // Optimistic Update
  if(wasBooked) delete bookings[activeDate];
  else bookings[activeDate] = note;
  
  closeModal();
  render();

  // Send to Backend
  const fd=new URLSearchParams({date:activeDate,note});
  try {
      await fetch(API_URL,{method:"POST",mode:"no-cors",body:fd});
  } catch(e) {
      alert("Network Error: Could not save.");
      // Revert
      if(wasBooked) bookings[activeDate] = note;
      else delete bookings[activeDate];
      render();
  }
}

function changeYear(n){
  currentYear+=n;
  render();
}

/* ========= INIT ========= */
const pass = prompt("Admin Password");
if(pass==="admin"){
  document.getElementById("app-container").style.display = "block";
  fetchBookings();
}else{
  document.body.innerHTML="<div style='height:100vh;display:flex;justify-content:center;align-items:center;flex-direction:column;color:#d4af37;background:#000'><h2 style='font-family:Cinzel'>ðŸ”’ Access Denied</h2></div>";
}
</script>
</body>
</html>
