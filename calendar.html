<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sampark Lodge | Admin Luxury Calendar</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

<style>
:root {
    /* Luxury Palette */
    --c-gold: #D4AF37;
    --c-gold-light: #F3E5AB;
    --c-gold-dark: #aa8c2c;
    --c-blue: #4a90e2; /* For Update Action */
    --c-red: #d9534f;  /* For Delete Action */
    --c-text-main: #1a1a1a;
    --c-text-muted: #666;
    
    --bg-glass: rgba(255, 255, 255, 0.85);
    --border-glass: 1px solid rgba(255, 255, 255, 0.6);
    --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.05);
    --shadow-hover: 0 12px 40px rgba(212, 175, 55, 0.2);

    --font-heading: 'Cinzel', serif;
    --font-body: 'Lato', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

body {
    font-family: var(--font-body);
    /* Background fallback if image is missing */
    background: #fdfcf8 url("./assets/bg.png") center/cover fixed; 
    color: var(--c-text-main);
    min-height: 100vh;
    padding-bottom: 60px;
    -webkit-font-smoothing: antialiased;
}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- LAYOUT --- */
.container {
    max-width: 1100px;
    margin: 40px auto;
    padding: 0 20px;
    display: none; /* Hidden until auth */
    animation: fadeIn 0.8s ease-out;
}

/* --- HEADER --- */
header {
    background: var(--bg-glass);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: var(--border-glass);
    padding: 35px;
    border-radius: 20px;
    box-shadow: var(--shadow-soft);
    text-align: center;
    position: relative;
    margin-bottom: 40px;
    border-bottom: 3px solid var(--c-gold);
}

header h1 {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    font-weight: 600;
    color: var(--c-text-main);
    letter-spacing: 2px;
    margin-bottom: 5px;
    text-transform: uppercase;
}

.subtitle {
    font-size: 0.85rem;
    color: var(--c-gold-dark);
    letter-spacing: 3px;
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 25px;
}

/* --- CONTROLS --- */
.year-nav {
    display: inline-flex;
    align-items: center;
    gap: 20px;
    background: #fff;
    padding: 8px 25px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(212, 175, 55, 0.3);
}

.nav-btn {
    background: transparent;
    border: none;
    color: var(--c-gold-dark);
    font-size: 1.5rem;
    cursor: pointer;
    transition: transform 0.2s;
    display: flex;
    align-items: center;
}

.nav-btn:hover { transform: scale(1.2); color: var(--c-gold); }

#year-display {
    font-family: var(--font-heading);
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--c-text-main);
    min-width: 80px;
    text-align: center;
}

.sync-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid rgba(0,0,0,0.05);
}

.sync-btn {
    background: #fff;
    border: 1px solid var(--c-gold);
    color: var(--c-gold-dark);
    padding: 8px 20px;
    font-size: 0.75rem;
    border-radius: 30px;
    cursor: pointer;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.sync-btn:hover {
    background: var(--c-gold);
    color: #fff;
    box-shadow: var(--shadow-hover);
}

#loading-text { 
    font-size: 0.85rem; 
    color: #888; 
    font-style: italic; 
}


/* --- CALENDAR GRID --- */
.calendar-wrapper {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
}
@media(min-width: 768px) {
    .calendar-wrapper { grid-template-columns: 1fr 1fr; }
}

.month-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(8px);
    padding: 25px;
    border-radius: 16px;
    box-shadow: var(--shadow-soft);
    border: 1px solid rgba(255,255,255,0.8);
    transition: transform 0.3s;
}

.month-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }

.month-name {
    text-align: center;
    font-family: var(--font-heading);
    color: var(--c-text-main);
    font-size: 1.3rem;
    margin-bottom: 20px;
    font-weight: 700;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding-bottom: 10px;
}

.days-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    margin-bottom: 10px;
}

.day-name {
    text-align: center;
    font-size: 0.7rem;
    font-weight: 800;
    color: var(--c-gold-dark);
    text-transform: uppercase;
}

.days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
}

/* --- DATE CELLS --- */
.date-cell {
    min-height: 90px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    justify-content: space-evenly;
    align-items: center;
    cursor: pointer;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.03);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    padding: 5px 0;
}

.date-cell:hover {
    border-color: var(--c-gold);
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(212, 175, 55, 0.15);
    z-index: 2;
}

.date-cell.empty { background: transparent; border: none; cursor: default; min-height: 0; }

/* Booked State - Luxury Gold Gradient */
.date-cell.booked {
    background: linear-gradient(135deg, #D4AF37 0%, #C5A028 100%);
    color: #fff;
    border: none;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
}

.eng-date {
    font-size: 1.1rem; 
    font-weight: 700;
    line-height: 1;
}

.ben-date {
    font-size: 0.65rem;
    line-height: 1.2;
    text-align: center;
    opacity: 0.7;
    font-weight: 400;
}

.date-cell.booked .ben-date { opacity: 0.95; color: rgba(255,255,255,0.95); }


/* --- MODAL (POPUP) --- */
#modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26, 26, 26, 0.6);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 5000;
}

.modal {
    background: #fff;
    width: 90%;
    max-width: 420px;
    padding: 35px;
    border-radius: 20px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    text-align: center;
    border: 1px solid rgba(212, 175, 55, 0.3);
    animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.modal h3 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    color: var(--c-text-main);
    margin-bottom: 5px;
}

.modal-date-sub {
    font-size: 0.9rem;
    color: var(--c-gold);
    font-family: var(--font-heading);
    margin-bottom: 25px;
    display: block;
}

/* Form Styles */
.form-group {
    margin-bottom: 20px;
    text-align: left;
}

.form-label {
    font-size: 0.75rem;
    color: var(--c-gold-dark);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: block;
}

/* Custom Select Dropdown */
.custom-select {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(212, 175, 55, 0.4);
    border-radius: 8px;
    background: #fafafa;
    color: var(--c-text-main);
    font-family: var(--font-body);
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23D4AF37%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 15px top 50%;
    background-size: 12px auto;
}

.modal textarea {
    width: 100%;
    height: 80px;
    padding: 12px;
    border: 1px solid rgba(212, 175, 55, 0.4);
    border-radius: 8px;
    font-family: var(--font-body);
    font-size: 0.95rem;
    resize: none;
    background: #fafafa;
    transition: border-color 0.3s;
}

.custom-select:focus, .modal textarea:focus {
    border-color: var(--c-gold);
    background: #fff;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
}

/* Modal Buttons */
.modal-btns { display: flex; gap: 10px; margin-top: 10px; }

.btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s;
}

.btn-save { background: var(--c-gold); color: #fff; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
.btn-save:hover { background: var(--c-gold-dark); transform: translateY(-2px); }

.btn-update { background: var(--c-blue); color: #fff; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); }
.btn-update:hover { filter: brightness(90%); transform: translateY(-2px); }

.btn-del { background: #fff; border: 1px solid var(--c-red); color: var(--c-red); }
.btn-del:hover { background: var(--c-red); color: #fff; }

.btn-cancel { background: #f0f0f0; color: #666; }
.btn-cancel:hover { background: #e0e0e0; }

/* --- AUTH SCREEN --- */
#auth-overlay {
    position: fixed; inset: 0;
    background: #111;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: var(--c-gold);
    z-index: 6000;
}

</style>
</head>
<body>

    <div id="auth-overlay">
        <h2 style="font-family: 'Cinzel'; font-size: 2.5rem; letter-spacing: 2px;">SAMPARK LODGE</h2>
        <p style="color: #666; margin-top: 10px; letter-spacing: 1px;">SECURE ADMIN ACCESS</p>
    </div>

    <div class="container" id="app">
        <header>
            <h1>Sampark Lodge</h1>
            <div class="subtitle">Admin Booking Dashboard</div>

            <div class="header-controls">
                <div class="year-nav">
                    <button class="nav-btn" onclick="changeYear(-1)">&#8249;</button>
                    <span id="year-display">2026</span>
                    <button class="nav-btn" onclick="changeYear(1)">&#8250;</button>
                </div>
            </div>

            <div class="sync-wrapper">
                <div id="loading-text">Last synced: Just now</div>
                <button class="sync-btn" onclick="fetchBookings()">↻ Refresh</button>
            </div>
        </header>

        <div class="calendar-wrapper" id="calendar"></div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h3 id="modal-title-main">Date</h3>
            <span id="modal-title-sub" class="modal-date-sub">Bengali Date</span>

            <div class="form-group">
                <label class="form-label">Booking Time</label>
                <select id="time-select" class="custom-select">
                    <option value="Morning">Morning (সকাল)</option>
                    <option value="Day">Day (দিন)</option>
                    <option value="Night">Night (রাত্রি)</option>
                    <option value="Full Day">Full Day (সম্পূর্ণ দিন)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Booking Details</label>
                <textarea id="note-input" placeholder="Client Name, Event Type, Amount..."></textarea>
            </div>

            <div id="action-buttons" class="modal-btns">
            </div>
        </div>
    </div>

<script>
/* ================= CONFIGURATION ================= */
// Replace with your Google Script Deployment URL if different
const API_URL = "https://script.google.com/macros/s/AKfycbzts3-BHw_-Vhm0S5j3P5s6ZtioILUQxp0kN_AFqe7yiAyPWFN69KTgESIMfOJYzPtU6w/exec";

let currentYear = new Date().getFullYear();
let bookings = {}; // Stores "YYYY-MM-DD": "Time - Details"
let selectedDate = null;

/* ================= AUTHENTICATION ================= */
document.addEventListener("DOMContentLoaded", () => {
    // Simple password gate
    if(prompt("Enter Admin Password:") === "admin") {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("app").style.display = "block";
        renderCalendar();
        fetchBookings();
    } else {
        alert("Incorrect Password. Refresh to try again.");
    }
});

/* ================= CALENDAR LOGIC ================= */

// Bengali Panjika Calculation
function getBengaliDate(jsDate) {
    const y = jsDate.getFullYear(), m = jsDate.getMonth(), d = jsDate.getDate();
    const starts = [
        new Date(y-1,11,16), new Date(y,0,15), new Date(y,1,14), new Date(y,2,15), 
        new Date(y,3,14), new Date(y,4,15), new Date(y,5,15), new Date(y,6,16), 
        new Date(y,7,16), new Date(y,8,16), new Date(y,9,16), new Date(y,10,15)
    ];
    const monthNames = ["পৌষ","মাঘ","ফাল্গুন","চৈত্র","বৈশাখ","জ্যৈষ্ঠ","আষাঢ়","শ্রাবণ","ভাদ্র","আশ্বিন","কার্তিক","অগ্রহায়ণ"];

    let bnMonthIndex = 0, bnDay = 1;
    for(let i=11; i>=0; i--) {
        if(jsDate >= starts[i]) {
            bnMonthIndex = i;
            const diffTime = Math.abs(jsDate - starts[i]);
            bnDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            break;
        }
    }
    if(jsDate < starts[0]) { bnMonthIndex = 0; bnDay = d + 16; }

    const toBnNum = n => n.toString().replace(/\d/g, d => "০১২৩৪৫৬৭৮৯"[d]);
    return `${toBnNum(bnDay)} ${monthNames[bnMonthIndex]}`;
}

// Render the Grid
function renderCalendar() {
    document.getElementById("year-display").innerText = currentYear;
    const grid = document.getElementById("calendar");
    grid.innerHTML = "";

    const engMonths = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    for(let m=0; m<12; m++) {
        const card = document.createElement("div");
        card.className = "month-card";

        let html = `<div class="month-name">${engMonths[m]}</div>`;
        html += `<div class="days-header">`;
        ["S","M","T","W","T","F","S"].forEach(d => html += `<div class="day-name">${d}</div>`);
        html += `</div><div class="days-grid">`;

        const firstDay = new Date(currentYear, m, 1).getDay();
        const daysInMonth = new Date(currentYear, m+1, 0).getDate();

        for(let i=0; i<firstDay; i++) html += `<div class="date-cell empty"></div>`;

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isBooked = bookings.hasOwnProperty(dateStr) ? "booked" : "";
            const jsDate = new Date(currentYear, m, d);
            const benDate = getBengaliDate(jsDate);

            html += `
            <div class="date-cell ${isBooked}" onclick="openModal('${dateStr}')">
                <span class="eng-date">${d}</span>
                <span class="ben-date">${benDate}</span>
            </div>`;
        }
        html += `</div>`;
        card.innerHTML = html;
        grid.appendChild(card);
    }
}

// Data Fetching
async function fetchBookings() {
    const loader = document.getElementById("loading-text");
    loader.innerText = "Syncing with database...";
    try {
        const res = await fetch(API_URL);
        const data = await res.json();

        bookings = {};
        data.forEach(item => bookings[item.date] = item.note || "");

        renderCalendar();
        loader.innerText = "Last synced: Just now";
    } catch(e) {
        loader.innerText = "Sync Failed. Check internet.";
        console.error(e);
    }
}

function changeYear(dir) {
    currentYear += dir;
    renderCalendar();
}

/* ================= MODAL & BOOKING LOGIC ================= */

function openModal(dateStr) {
    selectedDate = dateStr;
    const [y, m, d] = dateStr.split('-');
    const jsDate = new Date(y, m-1, d);

    // Set Header
    const niceDate = jsDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    const bnDate = getBengaliDate(jsDate);
    document.getElementById("modal-title-main").innerText = niceDate;
    document.getElementById("modal-title-sub").innerText = bnDate;

    // Elements
    const timeSelect = document.getElementById("time-select");
    const noteInput = document.getElementById("note-input");
    const btnContainer = document.getElementById("action-buttons");

    // Check Status
    const rawNote = bookings[dateStr];
    const isBooked = !!rawNote;

    if (isBooked) {
        // --- EDIT MODE (BOOKED) ---
        // Attempt to parse "Time - Details"
        let timePart = "Full Day"; 
        let detailPart = rawNote;
        const separator = " - ";
        const knownTimes = ["Morning", "Day", "Night", "Full Day"];
        
        if (rawNote.includes(separator)) {
            const splitIndex = rawNote.indexOf(separator);
            const potentialTime = rawNote.substring(0, splitIndex);
            if (knownTimes.includes(potentialTime)) {
                timePart = potentialTime;
                detailPart = rawNote.substring(splitIndex + separator.length);
            }
        }

        timeSelect.value = timePart;
        noteInput.value = detailPart;

        // Buttons: Close | Cancel (Red) | Update (Blue)
        btnContainer.innerHTML = `
            <button class="btn btn-cancel" onclick="closeModal()">Close</button>
            <button class="btn btn-del" onclick="deleteBooking()">Cancel Booking</button>
            <button class="btn btn-update" onclick="handleSave()">Update</button>
        `;

    } else {
        // --- NEW MODE (UNBOOKED) ---
        timeSelect.value = "Morning";
        noteInput.value = "";

        // Buttons: Close | Save (Gold)
        btnContainer.innerHTML = `
            <button class="btn btn-cancel" onclick="closeModal()">Close</button>
            <button class="btn btn-save" onclick="handleSave()">Save Booking</button>
        `;
    }

    document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal-overlay").style.display = "none";
}

// Unified Save/Update Logic
async function handleSave() {
    const time = document.getElementById("time-select").value;
    const details = document.getElementById("note-input").value.trim();

    if(!details) {
        alert("Please enter booking details.");
        return;
    }

    // Combine data
    const finalNote = `${time} - ${details}`;

    // Optimistic UI Update
    bookings[selectedDate] = finalNote;
    closeModal();
    renderCalendar();

    // API Call
    sendData(selectedDate, finalNote);
}

// Delete Logic
async function deleteBooking() {
    if(!confirm("Are you sure you want to cancel this booking?")) return;

    // Optimistic UI Delete
    delete bookings[selectedDate];
    closeModal();
    renderCalendar();

    // API Call (Send empty note)
    sendData(selectedDate, "");
}

// API Helper
async function sendData(date, note) {
    const formData = new URLSearchParams();
    formData.append("date", date);
    formData.append("note", note);

    try {
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: formData });
    } catch(e) {
        console.error("Network Error", e);
        alert("Warning: Saved locally, but network error occurred.");
    }
}

// Close modal on background click
document.getElementById("modal-overlay").addEventListener("click", e => {
    if(e.target.id === "modal-overlay") closeModal();
});

</script>
</body>
</html>
