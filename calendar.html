<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sampark Lodge | Admin Calendar</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

<style>
:root {
    --c-gold: #D4AF37;
    --c-gold-dim: #C5A028;
    --c-white: #ffffff;
    --c-text: #333;
    --font-h: 'Cinzel', serif;
    --font-b: 'Lato', sans-serif;
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: var(--font-b);
    /* Make sure bg.png is in the assets folder */
    background: #f4f4f4 url("./assets/bg.png") center/cover fixed;
    min-height: 100vh;
    padding-bottom: 50px;
    color: var(--c-text);
}

/* --- LAYOUT --- */
.container {
    max-width: 1000px;
    margin: 40px auto;
    padding: 0 20px;
    display: none; /* Hidden until login */
}

/* --- HEADER --- */
header {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    border-top: 4px solid var(--c-gold);
    text-align: center;
    position: relative;
    margin-bottom: 30px;
}

header h1 {
    font-family: var(--font-h);
    font-size: 2.2rem;
    color: #222;
    margin-bottom: 5px;
    letter-spacing: 1px;
}

.subtitle {
    font-size: 0.9rem;
    color: #666;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 20px;
}

.year-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
}

.nav-btn {
    background: transparent;
    border: 1px solid var(--c-gold);
    color: var(--c-gold-dim);
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.nav-btn:hover {
    background: var(--c-gold);
    color: #fff;
}

#year-display {
    font-family: var(--font-h);
    font-size: 1.8rem;
    font-weight: bold;
    color: #222;
    min-width: 80px;
    text-align: center;
}

.sync-btn {
    position: absolute;
    right: 20px;
    top: 20px;
    background: transparent;
    border: 1px solid #ddd;
    padding: 6px 12px;
    font-size: 0.75rem;
    border-radius: 20px;
    cursor: pointer;
    color: #666;
    transition: 0.3s;
    font-family: var(--font-b);
}
.sync-btn:hover { border-color: var(--c-gold); color: var(--c-gold); }


/* --- CALENDAR GRID --- */
.calendar-wrapper {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
}
@media(min-width: 768px) {
    .calendar-wrapper { grid-template-columns: 1fr 1fr; }
}

.month-card {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(212, 175, 55, 0.2);
}

.month-name {
    text-align: center;
    font-family: var(--font-h);
    color: var(--c-gold-dim);
    font-size: 1.2rem;
    margin-bottom: 15px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.days-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    margin-bottom: 10px;
}

.day-name {
    text-align: center;
    font-size: 0.75rem;
    font-weight: bold;
    color: #888;
}

.days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
}

.date-cell {
    aspect-ratio: 1;
    border: 1px solid #eee;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    background: #fff;
    transition: transform 0.2s, border-color 0.2s;
    position: relative;
}

.date-cell:hover {
    border-color: var(--c-gold);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.date-cell.empty { background: transparent; border: none; cursor: default; }

/* BOOKED STATUS */
.date-cell.booked {
    background: var(--c-gold);
    color: #fff;
    border-color: var(--c-gold);
}

.eng-date {
    font-size: 1.1rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 2px;
    font-family: var(--font-h);
}

.ben-date {
    font-size: 0.6rem;
    line-height: 1.1;
    text-align: center;
    opacity: 0.8;
}

.date-cell.booked .ben-date { opacity: 0.9; color: #fff; }


/* --- MODAL --- */
#modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(3px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.modal {
    background: #fff;
    width: 90%;
    max-width: 400px;
    padding: 30px;
    border-radius: 12px;
    border-top: 5px solid var(--c-gold);
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal h3 {
    font-family: var(--font-h);
    text-align: center;
    margin-bottom: 20px;
    color: #222;
    line-height: 1.4;
}

.modal textarea {
    width: 100%;
    height: 100px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: var(--font-b);
    resize: none;
    margin-bottom: 20px;
}
.modal textarea:focus { outline: none; border-color: var(--c-gold); }

.modal-btns {
    display: flex;
    gap: 10px;
}

.btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    font-size: 0.9rem;
    transition: opacity 0.2s;
}

.btn-save { background: var(--c-gold); color: #fff; }
.btn-del { background: #d32f2f; color: #fff; }
.btn-cancel { background: #f0f0f0; color: #333; }
.btn:hover { opacity: 0.9; }


/* --- AUTH OVERLAY --- */
#auth-overlay {
    position: fixed; inset: 0;
    background: #111;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: var(--c-gold);
    z-index: 3000;
}

#loading-text {
    text-align: center;
    margin-top: 10px;
    font-size: 0.8rem;
    color: #888;
    height: 20px;
}

</style>
</head>
<body>

    <div id="auth-overlay">
        <h2 style="font-family: 'Cinzel'; font-size: 2rem;">ðŸ”’ Restricted Access</h2>
        <p style="color: #666; margin-top: 10px;">Sampark Lodge Admin</p>
    </div>

    <div class="container" id="app">
        <header>
            <button class="sync-btn" onclick="fetchBookings()">â†» Sync Data</button>
            <h1>SAMPARK LODGE</h1>
            <div class="subtitle">Admin Booking Calendar</div>
            
            <div class="header-controls">
                <div class="year-nav">
                    <button class="nav-btn" onclick="changeYear(-1)">â€¹</button>
                    <span id="year-display">2026</span>
                    <button class="nav-btn" onclick="changeYear(1)">â€º</button>
                </div>
            </div>
            <div id="loading-text"></div>
        </header>

        <div class="calendar-wrapper" id="calendar">
            </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h3 id="modal-title">Date Info</h3>
            <textarea id="note-input" placeholder="Add Note (e.g., Wedding - Mr. Sharma)"></textarea>
            <div class="modal-btns">
                <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button id="save-btn" class="btn btn-save" onclick="saveBooking()">Save</button>
            </div>
        </div>
    </div>

<script>
/* ================= CONFIG ================= */
// YOUR EXACT URL (From previous chat)
const API_URL = "https://script.google.com/macros/s/AKfycbzts3-BHw_-Vhm0S5j3P5s6ZtioILUQxp0kN_AFqe7yiAyPWFN69KTgESIMfOJYzPtU6w/exec";
let currentYear = new Date().getFullYear();
let bookings = {}; // Stores "YYYY-MM-DD": "Note"
let selectedDate = null;

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
    if(prompt("Enter Admin Password:") === "admin") {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("app").style.display = "block";
        renderCalendar();
        fetchBookings();
    } else {
        alert("Incorrect Password.");
    }
});

/* ================= LOGIC ================= */

function getBengaliDate(jsDate) {
    const y = jsDate.getFullYear(), m = jsDate.getMonth(), d = jsDate.getDate();
    const starts = [
        new Date(y-1,11,16), new Date(y,0,15), new Date(y,1,14), new Date(y,2,15), 
        new Date(y,3,14), new Date(y,4,15), new Date(y,5,15), new Date(y,6,16), 
        new Date(y,7,16), new Date(y,8,16), new Date(y,9,16), new Date(y,10,15)
    ];
    const monthNames = ["à¦ªà§Œà¦·","à¦®à¦¾à¦˜","à¦«à¦¾à¦²à§à¦—à§à¦¨","à¦šà§ˆà¦¤à§à¦°","à¦¬à§ˆà¦¶à¦¾à¦–","à¦œà§à¦¯à§ˆà¦·à§à¦ ","à¦†à¦·à¦¾à¦¢à¦¼","à¦¶à§à¦°à¦¾à¦¬à¦£","à¦­à¦¾à¦¦à§à¦°","à¦†à¦¶à§à¦¬à¦¿à¦¨","à¦•à¦¾à¦°à§à¦¤à¦¿à¦•","à¦…à¦—à§à¦°à¦¹à¦¾à¦¯à¦¼à¦£"];
    
    let bnMonthIndex = 0, bnDay = 1;
    for(let i=11; i>=0; i--) {
        if(jsDate >= starts[i]) {
            bnMonthIndex = i;
            const diffTime = Math.abs(jsDate - starts[i]);
            bnDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            break;
        }
    }
    if(jsDate < starts[0]) { bnMonthIndex = 0; bnDay = d + 16; }

    const toBnNum = n => n.toString().replace(/\d/g, d => "à§¦à§§à§¨à§©à§ªà§«à§¬à§­à§®à§¯"[d]);
    return `${toBnNum(bnDay)} ${monthNames[bnMonthIndex]}`;
}

function renderCalendar() {
    document.getElementById("year-display").innerText = currentYear;
    const grid = document.getElementById("calendar");
    grid.innerHTML = "";
    
    const engMonths = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    
    for(let m=0; m<12; m++) {
        const card = document.createElement("div");
        card.className = "month-card";
        
        let html = `<div class="month-name">${engMonths[m]}</div>`;
        html += `<div class="days-header">`;
        ["S","M","T","W","T","F","S"].forEach(d => html += `<div class="day-name">${d}</div>`);
        html += `</div><div class="days-grid">`;
        
        const firstDay = new Date(currentYear, m, 1).getDay();
        const daysInMonth = new Date(currentYear, m+1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) html += `<div class="date-cell empty"></div>`;
        
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            
            // --- FIX IS HERE ---
            // We check hasOwnProperty to ensure empty notes still count as booked
            const isBooked = bookings.hasOwnProperty(dateStr) ? "booked" : "";
            
            const jsDate = new Date(currentYear, m, d);
            const benDate = getBengaliDate(jsDate);
            
            html += `
            <div class="date-cell ${isBooked}" onclick="openModal('${dateStr}')">
                <span class="eng-date">${d}</span>
                <span class="ben-date">${benDate}</span>
            </div>`;
        }
        
        html += `</div>`;
        card.innerHTML = html;
        grid.appendChild(card);
    }
}

async function fetchBookings() {
    const loader = document.getElementById("loading-text");
    loader.innerText = "Syncing...";
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        
        // Populate bookings map
        bookings = {};
        data.forEach(item => {
            // Store empty string if note is missing
            bookings[item.date] = item.note || "";
        });
        
        renderCalendar();
        loader.innerText = "";
    } catch(e) {
        loader.innerText = "Sync Error!";
        console.error(e);
    }
}

function changeYear(dir) {
    currentYear += dir;
    renderCalendar();
}

/* ================= INTERACTION ================= */
function openModal(dateStr) {
    selectedDate = dateStr;
    const [y, m, d] = dateStr.split('-');
    const jsDate = new Date(y, m-1, d);
    
    const niceDate = jsDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    const bnDate = getBengaliDate(jsDate);
    
    document.getElementById("modal-title").innerHTML = `${niceDate}<br><span style="font-size:0.8em; color:#d4af37">${bnDate}</span>`;
    
    // Check if property exists, NOT if it evaluates to true
    const exists = bookings.hasOwnProperty(dateStr);
    document.getElementById("note-input").value = exists ? bookings[dateStr] : "";
    
    const btn = document.getElementById("save-btn");
    if(exists) {
        btn.innerText = "Remove Booking";
        btn.className = "btn btn-del";
    } else {
        btn.innerText = "Mark Booked";
        btn.className = "btn btn-save";
    }
    
    document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal-overlay").style.display = "none";
}

async function saveBooking() {
    const note = document.getElementById("note-input").value;
    const exists = bookings.hasOwnProperty(selectedDate);
    const oldNote = bookings[selectedDate];
    
    // --- OPTIMISTIC UI UPDATE ---
    // If it exists, we REMOVE it (Toggle Off)
    // If it doesn't exist, we ADD it (Toggle On)
    if(exists) {
        delete bookings[selectedDate];
    } else {
        bookings[selectedDate] = note;
    }
    
    closeModal();
    renderCalendar(); // Visual update happens immediately
    
    // Send to server
    const formData = new URLSearchParams();
    formData.append("date", selectedDate);
    formData.append("note", note);
    
    try {
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: formData });
    } catch(e) {
        alert("Network Error: Could not save.");
        // Revert change on error
        if(exists) bookings[selectedDate] = oldNote;
        else delete bookings[selectedDate];
        renderCalendar();
    }
}

document.getElementById("modal-overlay").addEventListener("click", e => {
    if(e.target.id === "modal-overlay") closeModal();
});

</script>
</body>
</html>
